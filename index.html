<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸œæ–¹çµä¾ Â· Eastern Spirit Keeper</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: "PingFang SC","Microsoft YaHei",serif;
            background:#f7f5f0; color:#2c2c2c; line-height:1.6;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .container {
            max-width:800px; margin:0 auto; height:100vh;
            display:flex; flex-direction:column;
            border-left:1px solid #e0dcd2; border-right:1px solid #e0dcd2;
            background:rgba(255,255,255,0.85);
            box-shadow:0 0 30px rgba(0,0,0,0.05);
        }
        .header {
            padding:1.2rem 1.5rem; border-bottom:1px solid #e0dcd2;
            background:linear-gradient(135deg,#f0ede6 0%,#f7f5f0 100%);
            display:flex; align-items:center; justify-content:space-between;
            gap:1rem;
        }
        .header-left { display:flex; align-items:center; gap:1rem; }
        .avatar {
            width:48px; height:48px; border-radius:50%;
            background:#d4c9b8; display:flex; align-items:center; justify-content:center;
            font-size:24px; color:#6b5d4f; border:2px solid #c2b7a6;
        }
        .title { font-size:1.3rem; font-weight:500; color:#4a4a4a; letter-spacing:0.05em; }
        .subtitle { font-size:0.85rem; color:#888; font-style:italic; }
        /* è®°å¿†é¢æ¿æŒ‰é’®æ ·å¼ */
        .mem-btn {
            padding:6px 12px; border-radius:12px; border:none;
            background:#6b5d4f; color:#fff; font-size:12px;
            cursor:pointer; transition:all 0.2s;
        }
        .mem-btn:hover { background:#5a4e42; }

        /* è®°å¿†é¢æ¿æ ·å¼ */
        .memory-panel {
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.5); z-index:999;
            display:none; align-items:center; justify-content:center;
            padding:20px;
        }
        .mem-content {
            background:#fff; border-radius:16px; padding:20px;
            max-width:500px; width:100%; max-height:80vh;
            overflow-y:auto; border:1px solid #e0dcd2;
        }
        .mem-title {
            font-size:18px; font-weight:500; color:#4a4a4a;
            margin-bottom:15px; padding-bottom:10px;
            border-bottom:1px solid #e0dcd2;
            text-align:center;
        }
        .mem-item {
            margin-bottom:10px; padding:8px;
            background:#f7f5f0; border-radius:8px;
        }
        .mem-label { font-weight:500; color:#6b5d4f; margin-right:8px; }
        .mem-close {
            display:block; width:100%; padding:8px;
            margin-top:20px; border:none; border-radius:8px;
            background:#6b5d4f; color:#fff; cursor:pointer;
        }

        .chat-area {
            flex:1; overflow-y:auto; padding:1.5rem;
            display:flex; flex-direction:column; gap:1.5rem;
        }
        .message {
            max-width:75%; padding:0.8rem 1.2rem; border-radius:18px;
            position:relative; animation:fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
        .user-message { align-self:flex-end; background:linear-gradient(135deg,#6b5d4f 0%,#5a4e42 100%); color:#fff; border-bottom-right-radius:4px; }
        .bot-message { align-self:flex-start; background:#f0ede6; color:#2c2c2c; border-bottom-left-radius:4px; border:1px solid #e0dcd2; }
        .input-area { padding:1rem 1.5rem; border-top:1px solid #e0dcd2; background:#fff; display:flex; gap:0.8rem; align-items:flex-end; }
        #userInput {
            flex:1; padding:0.8rem 1.2rem; border:1px solid #e0dcd2; border-radius:24px;
            font-family:inherit; font-size:1rem; resize:none; outline:none;
            background:#faf9f6; transition:all 0.2s;
        }
        #userInput:focus { border-color:#c2b7a6; background:#fff; }
        #sendBtn {
            padding:0.8rem 1.6rem; border:none; border-radius:24px;
            background:linear-gradient(135deg,#6b5d4f 0%,#5a4e42 100%);
            color:#fff; font-family:inherit; font-size:1rem; cursor:pointer;
            transition:all 0.2s;
        }
        #sendBtn:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(107,93,79,0.3); }
        #sendBtn:active { transform:translateY(0); }
        .typing { display:inline-block; width:40px; height:16px; position:relative; }
        .typing span {
            position:absolute; width:6px; height:6px; border-radius:50%;
            background:#888; animation:typing 1.4s infinite both;
        }
        .typing span:nth-child(1){left:0;animation-delay:-0.32s;}
        .typing span:nth-child(2){left:12px;animation-delay:-0.16s;}
        .typing span:nth-child(3){left:24px;animation-delay:0s;}
        @keyframes typing { 0%{transform:scale(0);}50%{transform:scale(1);}100%{transform:scale(0);} }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-left">
            <div class="avatar">çµ</div>
            <div>
                <div class="title">ä¸œæ–¹çµä¾</div>
                <div class="subtitle">Eastern Spirit Keeper</div>
            </div>
        </div>
        <!-- è®°å¿†é¢æ¿æŒ‰é’® -->
        <button class="mem-btn" onclick="toggleMemoryPanel()">ğŸ“‹ æˆ‘çš„è®°å¿†æ¡£æ¡ˆ</button>
    </div>

    <div class="chat-area" id="chatArea"></div>

    <div class="input-area">
        <textarea id="userInput" placeholder="ä¸çµä¾å¯¹è¯­..." rows="1"></textarea>
        <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
    </div>
</div>

<!-- è®°å¿†é¢æ¿å¼¹çª— -->
<div class="memory-panel" id="memoryPanel">
    <div class="mem-content">
        <div class="mem-title">çµä¾çš„ä¸“å±è®°å¿†æ¡£æ¡ˆ</div>
        <div id="memoryContent"></div>
        <button class="mem-close" onclick="toggleMemoryPanel()">å…³é—­</button>
    </div>
</div>

<script>
// ====================== å…¨å±€çŠ¶æ€ï¼ˆä¿®å¤ç‰ˆï¼‰======================
let memorySystem = JSON.parse(localStorage.getItem("mySpiritMemory")) || {
  userName: "",
  userAge: "",
  userCity: "",
  userJob: "",
  userStatus: "",
  userTraits: [],
  userPreferences: [],
  userPainPoints: [],
  userGoals: [],
  userKeyFacts: []
};

let relationship = JSON.parse(localStorage.getItem("mySpiritRelationship")) || {
  level: 1,
  intimacy: 0,
  lastChatTime: Date.now()
};

let chatHistory = JSON.parse(localStorage.getItem("mySpiritHistory")) || [];

// ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæ ¸å¿ƒï¼šæ·±æ‹·è´ï¼Œé¿å…å¼•ç”¨é—®é¢˜ï¼‰
function saveAll() {
  localStorage.setItem("mySpiritMemory", JSON.stringify({...memorySystem}));
  localStorage.setItem("mySpiritRelationship", JSON.stringify({...relationship}));
  localStorage.setItem("mySpiritHistory", JSON.stringify([...chatHistory]));
  console.log("âœ… æ‰€æœ‰æ•°æ®å·²æŒä¹…åŒ–ä¿å­˜");
}

// ====================== è®°å¿†é¢æ¿æ ¸å¿ƒé€»è¾‘ ======================
function toggleMemoryPanel() {
  const panel = document.getElementById("memoryPanel");
  panel.style.display = panel.style.display === "flex" ? "none" : "flex";
  renderMemoryPanel();
}

function renderMemoryPanel() {
  const content = document.getElementById("memoryContent");
  // æ ¼å¼åŒ–è®°å¿†æ•°æ®ï¼Œç©ºå€¼æ˜¾ç¤ºâ€œæœªè®°å½•â€
  const mem = memorySystem;
  let html = `
    <div class="mem-item"><span class="mem-label">å§“åï¼š</span>${mem.userName || "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">å¹´é¾„ï¼š</span>${mem.userAge || "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">åŸå¸‚ï¼š</span>${mem.userCity || "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">èŒä¸šï¼š</span>${mem.userJob || "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">æ„Ÿæƒ…çŠ¶æ€ï¼š</span>${mem.userStatus || "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">æ€§æ ¼ç‰¹ç‚¹ï¼š</span>${mem.userTraits.length > 0 ? mem.userTraits.join("ã€") : "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">å…´è¶£å–œå¥½ï¼š</span>${mem.userPreferences.length > 0 ? mem.userPreferences.join("ã€") : "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">å‹åŠ›çƒ¦æ¼ï¼š</span>${mem.userPainPoints.length > 0 ? mem.userPainPoints.join("ã€") : "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">ç›®æ ‡è®¡åˆ’ï¼š</span>${mem.userGoals.length > 0 ? mem.userGoals.join("ã€") : "æœªè®°å½•"}</div>
    <div class="mem-item"><span class="mem-label">å…³é”®ç»å†ï¼š</span>${mem.userKeyFacts.length > 0 ? mem.userKeyFacts.join("ã€") : "æœªè®°å½•"}</div>
  `;
  content.innerHTML = html;
}

// ====================== èŠå¤©åŸºç¡€é€»è¾‘ ======================
function appendMessage(role, text) {
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = role === "user" ? "message user-message" : "message bot-message";
  div.innerText = text;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function showTyping() {
  const area = document.getElementById("chatArea");
  const t = document.createElement("div");
  t.className = "message bot-message";
  t.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
  area.appendChild(t);
  return t;
}

// ====================== ä¸»åŠ¨æ¶ˆæ¯é€»è¾‘ ======================
function shouldSendProactive() {
  const now = Date.now();
 // const gapHour = (now - relationship.lastChatTime) / (1000 * 60 * 60);
 // return gapHour > (relationship.level < 2 ? 12 : 4);
  const gapMinute = (now - relationship.lastChatTime) / (1000 * 60 );//ååˆ†é’Ÿæ£€æµ‹æ˜¯å¦ä¼šå‘æ¶ˆæ¯
  return gapMinute > 10;
}

async function proactiveMessage() {
  const tip = showTyping();
  try {
    const res = await fetch("/api/eastern-spirit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userMessage: "[ä¸»åŠ¨æ¶ˆæ¯]",
        chatHistory,
        memorySystem,
        relationship,
        mode: "proactive"
      })
    });
    const data = await res.json();
    tip.remove();
    appendMessage("bot", data.reply);
    chatHistory.push({ role: "bot", content: data.reply });
    relationship.lastChatTime = Date.now();
    saveAll();
  } catch (e) {
    tip.remove();
    console.error("ä¸»åŠ¨æ¶ˆæ¯å¤±è´¥ï¼š", e);
  }
}

// ====================== ä¿®å¤ç‰ˆå‘é€æ¶ˆæ¯ï¼ˆæ ¸å¿ƒï¼šå…ˆå­˜è®°å¿†å†èŠå¤©ï¼‰=====================
async function sendMessage() {
  const ipt = document.getElementById("userInput");
  const text = ipt.value.trim();
  if (!text) return;

  // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
  appendMessage("user", text);
  ipt.value = "";
  const typingTip = showTyping();

  // 2. å…ˆæ›´æ–°åŸºç¡€çŠ¶æ€å¹¶ä¿å­˜
  chatHistory.push({ role: "user", content: text });
  relationship.lastChatTime = Date.now();
  saveAll();

  try {
    // 3. ç¬¬ä¸€æ­¥ï¼šä¼˜å…ˆæŠ½å–è®°å¿†ï¼ˆç¡®ä¿æ–°ä¿¡æ¯è¢«ä¿å­˜ï¼‰
    console.log("ğŸ”„ æ­£åœ¨æå–è®°å¿†...");
    const extractRes = await fetch("/api/eastern-spirit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userMessage: text,
        memorySystem: {...memorySystem}, // ä¼ å‰¯æœ¬ï¼Œé¿å…ä¿®æ”¹ä¸­å†²çª
        mode: "extract"
      })
    });

    if (extractRes.ok) {
      const updatedData = await extractRes.json();
      if (updatedData.memorySystem) {
        // æ·±åº¦æ›¿æ¢ï¼Œç¡®ä¿æœ¬åœ°è®°å¿†å®Œå…¨æ›´æ–°
        memorySystem = JSON.parse(JSON.stringify(updatedData.memorySystem));
        saveAll(); // æå–åç«‹å³ä¿å­˜
        console.log("âœ… è®°å¿†æå–æˆåŠŸï¼š", memorySystem);
      }
    } else {
      console.error("è®°å¿†æå–å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š", extractRes.status);
    }

    // 4. ç¬¬äºŒæ­¥ï¼šç”¨æœ€æ–°è®°å¿†ç”Ÿæˆå›å¤
    console.log("ğŸ”„ æ­£åœ¨ç”Ÿæˆå›å¤...");
    const chatRes = await fetch("/api/eastern-spirit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userMessage: text,
        chatHistory: [...chatHistory],
        memorySystem: {...memorySystem}, // ä¼ æœ€æ–°è®°å¿†
        relationship: {...relationship},
        mode: "chat"
      })
    });

    const chatData = await chatRes.json();
    typingTip.remove();
    const reply = chatData.reply || "æˆ‘åœ¨å‘¢ã€‚";
    appendMessage("bot", reply);

    // 5. æœ€åæ›´æ–°èŠå¤©å†å²å¹¶ä¿å­˜
    chatHistory.push({ role: "bot", content: reply });
    saveAll();

  } catch (e) {
    typingTip.remove();
    appendMessage("bot", "æŠ±æ­‰ï¼Œåˆšæ‰æœ‰ç‚¹èµ°ç¥äº†ã€‚");
    console.error("å‘é€æ¶ˆæ¯æ ¸å¿ƒé”™è¯¯ï¼š", e);
  }
}

// ====================== é¡µé¢åˆå§‹åŒ– ======================
window.onload = () => {
  // æ¢å¤å†å²èŠå¤©
  chatHistory.forEach(msg => appendMessage(msg.role, msg.content));
  // æ£€æŸ¥ä¸»åŠ¨æ¶ˆæ¯
  if (shouldSendProactive()) proactiveMessage();
     // æ¯ 1 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œè‡ªåŠ¨ä¸»åŠ¨å‘æ¶ˆæ¯
  setInterval(() => {
    if (shouldSendProactive()) {
      proactiveMessage();
    }
  }, 60000);
  // æ‰“å°åˆå§‹è®°å¿†ï¼Œæ–¹ä¾¿è°ƒè¯•
  console.log("ğŸ“„ åˆå§‹è®°å¿†åŠ è½½ï¼š", memorySystem);
};
</script>
</body>
</html>
