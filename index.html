<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>东方灵侍 · Eastern Spirit Keeper</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: "PingFang SC","Microsoft YaHei",serif;
            background:#f7f5f0; color:#2c2c2c; line-height:1.6;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .container {
            max-width:800px; margin:0 auto; height:100vh;
            display:flex; flex-direction:column;
            border-left:1px solid #e0dcd2; border-right:1px solid #e0dcd2;
            background:rgba(255,255,255,0.85);
            box-shadow:0 0 30px rgba(0,0,0,0.05);
        }
        .header {
            padding:1.2rem 1.5rem; border-bottom:1px solid #e0dcd2;
            background:linear-gradient(135deg,#f0ede6 0%,#f7f5f0 100%);
            display:flex; align-items:center; gap:1rem;
        }
        .avatar {
            width:48px; height:48px; border-radius:50%;
            background:#d4c9b8; display:flex; align-items:center; justify-content:center;
            font-size:24px; color:#6b5d4f; border:2px solid #c2b7a6;
        }
        .title { font-size:1.3rem; font-weight:500; color:#4a4a4a; letter-spacing:0.05em; }
        .subtitle { font-size:0.85rem; color:#888; font-style:italic; }
        .chat-area {
            flex:1; overflow-y:auto; padding:1.5rem;
            display:flex; flex-direction:column; gap:1.5rem;
        }
        .message {
            max-width:75%; padding:0.8rem 1.2rem; border-radius:18px;
            position:relative; animation:fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
        .user-message { align-self:flex-end; background:linear-gradient(135deg,#6b5d4f 0%,#5a4e42 100%); color:#fff; border-bottom-right-radius:4px; }
        .bot-message { align-self:flex-start; background:#f0ede6; color:#2c2c2c; border-bottom-left-radius:4px; border:1px solid #e0dcd2; }
        .input-area { padding:1rem 1.5rem; border-top:1px solid #e0dcd2; background:#fff; display:flex; gap:0.8rem; align-items:flex-end; }
        #userInput {
            flex:1; padding:0.8rem 1.2rem; border:1px solid #e0dcd2; border-radius:24px;
            font-family:inherit; font-size:1rem; resize:none; outline:none;
            background:#faf9f6; transition:all 0.2s;
        }
        #userInput:focus { border-color:#c2b7a6; background:#fff; }
        #sendBtn {
            padding:0.8rem 1.6rem; border:none; border-radius:24px;
            background:linear-gradient(135deg,#6b5d4f 0%,#5a4e42 100%);
            color:#fff; font-family:inherit; font-size:1rem; cursor:pointer;
            transition:all 0.2s;
        }
        #sendBtn:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(107,93,79,0.3); }
        #sendBtn:active { transform:translateY(0); }
        .typing { display:inline-block; width:40px; height:16px; position:relative; }
        .typing span {
            position:absolute; width:6px; height:6px; border-radius:50%;
            background:#888; animation:typing 1.4s infinite both;
        }
        .typing span:nth-child(1){left:0;animation-delay:-0.32s;}
        .typing span:nth-child(2){left:12px;animation-delay:-0.16s;}
        .typing span:nth-child(3){left:24px;animation-delay:0s;}
        @keyframes typing { 0%{transform:scale(0);}50%{transform:scale(1);}100%{transform:scale(0);} }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="avatar">灵</div>
        <div>
            <div class="title">东方灵侍</div>
            <div class="subtitle">Eastern Spirit Keeper</div>
        </div>
    </div>
    <div class="chat-area" id="chatArea"></div>
    <div class="input-area">
        <textarea id="userInput" placeholder="与灵侍对语..." rows="1"></textarea>
        <button id="sendBtn" onclick="sendMessage()">发送</button>
    </div>
</div>

<script>
// ====================== 全自动记忆系统（初始全空）======================
let memorySystem = JSON.parse(localStorage.getItem("mySpiritMemory")) || {
  userName: "",
  userAge: "",
  userCity: "",
  userJob: "",
  userStatus: "",
  userTraits: [],
  userPreferences: [],
  userPainPoints: [],
  userGoals: [],
  userKeyFacts: []
};

let relationship = JSON.parse(localStorage.getItem("mySpiritRelationship")) || {
  level: 1,
  intimacy: 0,
  lastChatTime: Date.now()
};

let chatHistory = JSON.parse(localStorage.getItem("mySpiritHistory")) || [];

// 保存到本地
function saveAll() {
  localStorage.setItem("mySpiritMemory", JSON.stringify(memorySystem));
  localStorage.setItem("mySpiritRelationship", JSON.stringify(relationship));
  localStorage.setItem("mySpiritHistory", JSON.stringify(chatHistory));
}

// 插入消息
function appendMessage(role, text) {
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = role === "user" ? "message user-message" : "message bot-message";
  div.innerText = text;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

// 正在输入
function showTyping() {
  const area = document.getElementById("chatArea");
  const t = document.createElement("div");
  t.className = "message bot-message";
  t.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
  area.appendChild(t);
  return t;
}

// ====================== 主动消息 ======================
function shouldSendProactive() {
  const now = Date.now();
  const gapHour = (now - relationship.lastChatTime) / (1000 * 60 * 60);
  return gapHour > (relationship.level < 2 ? 12 : 4);
}

async function proactiveMessage() {
  const tip = showTyping();
  try {
    const res = await fetch("/api/eastern-spirit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userMessage: "[主动消息]",
        chatHistory,
        memorySystem,
        relationship,
        mode: "proactive"
      })
    });
    const data = await res.json();
    tip.remove();
    appendMessage("bot", data.reply);
    chatHistory.push({ role: "bot", content: data.reply });
    relationship.lastChatTime = Date.now();
    saveAll();
  } catch (e) {
    tip.remove();
  }
}

// ====================== 自动提取记忆 ======================
async function extractAndSaveMemory(userText) {
  try {
    const res = await fetch("/api/eastern-spirit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userMessage: userText,
        memorySystem,
        mode: "extract"
      })
    });
    const updated = await res.json();
    if (updated.memorySystem) {
      memorySystem = updated.memorySystem;
      saveAll();
    }
  } catch (e) {}
}

// ====================== 发送消息 ======================
async function sendMessage() {
  const ipt = document.getElementById("userInput");
  const text = ipt.value.trim();
  if (!text) return;

  appendMessage("user", text);
  ipt.value = "";
  const tip = showTyping();

  chatHistory.push({ role: "user", content: text });
  relationship.lastChatTime = Date.now();
  saveAll();

  extractAndSaveMemory(text);

  try {
    const res = await fetch("/api/eastern-spirit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userMessage: text,
        chatHistory,
        memorySystem,
        relationship,
        mode: "chat"
      })
    });
    const data = await res.json();
    tip.remove();
    appendMessage("bot", data.reply);
    chatHistory.push({ role: "bot", content: data.reply });
    saveAll();
  } catch (e) {
    tip.remove();
    appendMessage("bot", "我在呢。");
  }
}

// 页面加载
window.onload = () => {
  chatHistory.forEach(msg => appendMessage(msg.role, msg.content));
  if (shouldSendProactive()) proactiveMessage();
};
</script>
</body>
</html>