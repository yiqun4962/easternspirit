<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>东方灵侍 · Eastern Spirit Keeper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", serif;
            background: #f7f5f0;
            color: #2c2c2c;
            line-height: 1.6;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0dcd2;
            border-right: 1px solid #e0dcd2;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
        }

        .header {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid #e0dcd2;
            background: linear-gradient(135deg, #f0ede6 0%, #f7f5f0 100%);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #d4c9b8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #6b5d4f;
            border: 2px solid #c2b7a6;
        }

        .title {
            font-size: 1.3rem;
            font-weight: 500;
            color: #4a4a4a;
            letter-spacing: 0.05em;
        }

        .subtitle {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 75%;
            padding: 0.8rem 1.2rem;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #6b5d4f 0%, #5a4e42 100%);
            color: #fff;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background: #f0ede6;
            color: #2c2c2c;
            border-bottom-left-radius: 4px;
            border: 1px solid #e0dcd2;
        }

        .input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e0dcd2;
            background: #fff;
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }

        #userInput {
            flex: 1;
            padding: 0.8rem 1.2rem;
            border: 1px solid #e0dcd2;
            border-radius: 24px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            outline: none;
            background: #faf9f6;
            transition: all 0.2s;
        }

        #userInput:focus {
            border-color: #c2b7a6;
            background: #fff;
        }

        #sendBtn {
            padding: 0.8rem 1.6rem;
            border: none;
            border-radius: 24px;
            background: linear-gradient(135deg, #6b5d4f 0%, #5a4e42 100%);
            color: #fff;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 93, 79, 0.3);
        }

        #sendBtn:active {
            transform: translateY(0);
        }

        .typing {
            display: inline-block;
            width: 40px;
            height: 16px;
            position: relative;
        }

        .typing span {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #888;
            animation: typing 1.4s infinite both;
        }

        .typing span:nth-child(1) { left: 0; animation-delay: -0.32s; }
        .typing span:nth-child(2) { left: 12px; animation-delay: -0.16s; }
        .typing span:nth-child(3) { left: 24px; animation-delay: 0s; }

        @keyframes typing {
            0% { transform: scale(0); }
            50% { transform: scale(1); }
            100% { transform: scale(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="avatar">灵</div>
            <div>
                <div class="title">东方灵侍</div>
                <div class="subtitle">Eastern Spirit Keeper</div>
            </div>
        </div>

        <div class="chat-area" id="chatArea">
    
        </div>

        <div class="input-area">
            <textarea id="userInput" placeholder="与灵侍对语..." rows="1"></textarea>
            <button id="sendBtn">发送</button>
        </div>
    </div>

    <script>
        //let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];//历史记录
        const chatArea = document.getElementById('chatArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        //let conversationHistory = [];
        //let conversationHistory =JSON.parse(localStorage.getItem("conversationHistory")) || [];
      let conversationData =
  JSON.parse(localStorage.getItem("conversationData")) || {
    conversationHistory: [],
    memory: {
      userName: ""
    },
    superStyleProfile: {
      ambition: 0,
  emotionalDepth: 0,
  stability: 0,
  dominance: 0,
  curiosity: 0,
  rationality: 0,
  vulnerability: 0
    },
    relationship: {
      intimacy: 0,
      trust: 0,
      depth: 0
    }
  };
        // 自动调整输入框高度
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
        });
function analyzeUserStyle(message) {

    if (!conversationData.superStyleProfile) {
        conversationData.superStyleProfile = {
            ambition: 0,
            emotionalDepth: 0,
            stability: 0,
            dominance: 0,
            curiosity: 0,
            rationality: 0,
            vulnerability: 0
        };
    }

    const style = conversationData.superStyleProfile;
    const text = message.toLowerCase();

    if (/目标|计划|创业|赚钱|效率/.test(text)) {
        style.ambition += 1;
    }

    if (/难受|压力|孤独|焦虑/.test(text)) {
        style.emotionalDepth += 1;
    }

localStorage.setItem(
    "conversationData",
    JSON.stringify(conversationData)
);
}

        function updateRelationship(message) {

    if (!conversationData.relationship) {
        conversationData.relationship = {
            intimacy: 0,
            trust: 0,
            depth: 0,
            level: 1
        };
    }

    conversationData.relationship.intimacyScore += 1;

    if (conversationData.relationship.intimacyScore > 20) {
        conversationData.relationship.level = 2;
    }

    localStorage.setItem("conversationData", JSON.stringify(conversationData));
}
        // 发送消息
        async function sendMessage() {
            //const text = userInput.value.trim();
           // if (!text) return;

            // 添加用户消息
           // addMessage(text, 'user');
          //  userInput.value = '';
          //  userInput.style.height = 'auto';
            const inputElement = document.getElementById("userInput");
    const userMessage = inputElement.value.trim();

    if (!userMessage) return;
  // 立即显示用户消息
    addMessage(userMessage, 'user');

    // 清空输入框
    inputElement.value = '';
    inputElement.style.height = 'auto';

    analyzeUserStyle(userMessage);
    updateRelationship(userMessage);

            // 自动识别名字
const nameMatch = userMessage.match(/我叫(.+)|我是(.+)/);

if (nameMatch) {
    const name = nameMatch[1] || nameMatch[2];
    conversationData.memory.userName = name;
    localStorage.setItem("conversationData", JSON.stringify(conversationData));
}

            // 显示“正在输入”
            const typingIndicator = addTypingIndicator();

            try {
                const response = await fetch('/api/eastern-spirit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                   // body: JSON.stringify({
                   //     userMessage: text,
                        //history: conversationHistory
                   //      history: conversationHistory.slice(-10)
                   // })
                    body: JSON.stringify({
  userMessage,
  history: conversationData.conversationHistory.slice(-10),
  superStyleProfile: conversationData.superStyleProfile,
  relationship: conversationData.relationship,
  memory: conversationData.memory
})
                }) 

                if (!response.ok) throw new Error('请求失败');

                // 处理流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessageElement = null;
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices?.[0]?.delta?.content || '';
                                fullText += content;

                                if (!botMessageElement) {
                                    typingIndicator.remove();
                                    botMessageElement = document.createElement('div');
                                    botMessageElement.className = 'message bot-message';
                                    chatArea.appendChild(botMessageElement);
                                }
                                botMessageElement.textContent = fullText;
                                chatArea.scrollTop = chatArea.scrollHeight;
                            } catch (e) {
                                console.error('解析流数据失败', e);
                            }
                        }
                    }
                }

                // 更新对话历史
             conversationData.conversationHistory.push(
    { role: 'user', content: userMessage },
    { role: 'assistant', content: fullText }
);
                
                // 限制最多 200 条
if (conversationData.conversationHistory.length > 200) {
   conversationData.conversationHistory = conversationData.conversationHistory.slice(-200);
}

localStorage.setItem(
    "conversationData",
    JSON.stringify(conversationData)
);

            } catch (err) {
                console.error(err);
                typingIndicator.remove();
                addMessage('抱歉，暂时无法回应。', 'bot');
            }
        }

        // 添加消息到界面
        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}-message`;
            div.textContent = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 添加“正在输入”指示器
        function addTypingIndicator() {
            const div = document.createElement('div');
            div.className = 'message bot-message typing';
            div.innerHTML = '<span></span><span></span><span></span>';
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
            return div;
        }

         window.onload = function () {
    if (conversationData.conversationHistory.length === 0) {
        const welcome = "君安。我是东方灵侍，愿为你温一盏茶，静听心事。";
        addMessage(welcome, "bot");
        conversationData.conversationHistory.push({
            role: "assistant",
            content: welcome
        });
        localStorage.setItem(
            "conversationData",
            JSON.stringify(conversationData)
        );
    } else {
        conversationData.conversationHistory.forEach(msg => {
            const sender = msg.role === "assistant" ? "bot" : "user";
            addMessage(msg.content, sender);
        });
    }
};
        // 绑定事件
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
