<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>东方灵侍 - Eastern Spirit Keeper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5A2B',
                        secondary: '#D2B48C',
                        background: '#F5F2EB',
                        chatBot: '#FFFFFF',
                        chatUser: '#3A2618',
                    },
                    fontFamily: {
                        song: ['STSong', 'serif'],
                        sans: ['Helvetica', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .chat-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
            .scrollbar-hide::-webkit-scrollbar { display: none; }
            .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        }
    </style>
</head>
<body class="bg-background min-h-screen font-song text-gray-800">
    <div class="flex flex-col h-screen max-w-3xl mx-auto">
        <header class="flex items-center justify-between p-4 bg-primary/90 text-white shadow-md">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-primary font-bold text-xl">灵</div>
                <div>
                    <h1 class="text-xl font-bold">东方灵侍</h1>
                    <p class="text-sm opacity-80">Eastern Spirit Keeper</p>
                </div>
            </div>
            <button id="memoryBtn" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-md text-sm transition-colors">
                <i class="fa fa-book"></i> 我记得的你
            </button>
        </header>

        <div id="chatContainer" class="flex-1 p-4 overflow-y-auto scrollbar-hide space-y-4"></div>

        <footer class="p-4 bg-white shadow-inner">
            <div class="flex items-center gap-3 max-w-2xl mx-auto">
                <input id="userInput" placeholder="请输入你的想法，与东方灵侍对话..."
                    class="flex-1 px-4 py-2.5 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                <button id="sendBtn" class="w-12 h-12 rounded-full bg-primary hover:bg-primary/90 text-white flex items-center justify-center transition-colors">
                    <i class="fa fa-paper-plane-o text-xl"></i>
                </button>
            </div>
        </footer>
    </div>

    <div id="memoryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 bg-primary text-white flex items-center justify-between">
                <h2 class="font-bold text-lg">我记得的你</h2>
                <button id="closeModal" class="text-white hover:text-gray-200"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div id="memoryContent" class="flex-1 p-4 overflow-y-auto scrollbar-hide space-y-3"></div>
            <div class="p-3 bg-gray-50 flex justify-end gap-2">
                <button id="exportMemories" class="px-3 py-1.5 border border-gray-300 rounded-md text-sm hover:bg-gray-100">
                    <i class="fa fa-download mr-1"></i> 导出
                </button>
                <button id="clearMemories" class="px-3 py-1.5 border border-red-300 text-red-600 rounded-md text-sm hover:bg-red-50">
                    <i class="fa fa-trash mr-1"></i> 清空
                </button>
            </div>
        </div>
    </div>

    <script>
        const GREETING_MESSAGES = {
            lessThanOneDay: ["昨天和你聊得很开心，今天也想打个招呼～","我还记着上次和你聊的事，今天来打个招呼。"],
            oneToSevenDays: ["这几天没见，你还好吗？","记挂着你，这几天过得怎么样呀？"],
            moreThanSevenDays: ["好久不见，最近在忙什么呀？","许久没和你对话了，最近一切顺利吗？"],
            firstTime: ["你好呀：）","很高兴认识你，能告诉我你的名字吗？：）"]
        };

        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        let longTermFacts = JSON.parse(localStorage.getItem('longTermFacts')) || [];
        const lastChatTime = localStorage.getItem('lastChatTime');
        const userId = localStorage.getItem('userId') || 'user_' + Date.now() + '_' + Math.random().toString(36).slice(2,10);
        localStorage.setItem('userId', userId);

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const memoryBtn = document.getElementById('memoryBtn');
        const memoryModal = document.getElementById('memoryModal');
        const closeModal = document.getElementById('closeModal');
        const memoryContent = document.getElementById('memoryContent');
        const clearMemories = document.getElementById('clearMemories');
        const exportMemories = document.getElementById('exportMemories');

        function getAutoGreeting() {
            const h = lastChatTime ? (Date.now() - +lastChatTime) / (1000*60*60) : null;
            if (!h) return GREETING_MESSAGES.firstTime;
            if (h < 24) return GREETING_MESSAGES.lessThanOneDay;
            if (h < 168) return GREETING_MESSAGES.oneToSevenDays;
            return GREETING_MESSAGES.moreThanSevenDays;
        }

        function renderChat() {
            chatContainer.innerHTML = '';
            if (chatHistory.length === 0) {
                const g = getAutoGreeting();
                addBotMessage(g[Math.floor(Math.random()*g.length)], false);
                return;
            }
            chatHistory.forEach(m => {
                m.role === 'user' ? addUserMessage(m.content, false) : addBotMessage(m.content, false);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addUserMessage(text, save = true) {
            const div = document.createElement('div');
            div.className = 'flex justify-end';
            div.innerHTML = `<div class="max-w-[75%] bg-chatUser text-white p-3 rounded-lg rounded-tr-none chat-shadow"><p class="whitespace-pre-wrap">${text}</p></div>`;
            chatContainer.appendChild(div);
            if (save) {
                chatHistory.push({ role: 'user', content: text });
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('lastChatTime', Date.now());
            }
        }

        function addBotMessage(text, save = true) {
            const div = document.createElement('div');
            div.className = 'flex justify-start';
            div.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-primary mr-3 flex-shrink-0"><i class="fa fa-comment-o"></i></div>
                <div class="max-w-[75%] bg-chatBot p-3 rounded-lg rounded-tl-none chat-shadow"><p class="whitespace-pre-wrap">${text}</p></div>
            `;
            chatContainer.appendChild(div);
            if (save) {
                chatHistory.push({ role: 'assistant', content: text });
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function renderMemories() {
            if (longTermFacts.length === 0) {
                memoryContent.innerHTML = `<div class="text-gray-500 text-center py-8">还没有记忆，开始聊天吧～</div>`;
                return;
            }
            memoryContent.innerHTML = longTermFacts.map((f,i) => `
                <div class="p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                    <p class="text-gray-700">${f}</p>
                    <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                        <span>${new Date().toLocaleDateString()}</span>
                        <button class="del-mem text-red-500 hover:text-red-700" data-i="${i}">×</button>
                    </div>
                </div>
            `).join('');
            document.querySelectorAll('.del-mem').forEach(b => b.onclick = () => {
                longTermFacts.splice(+b.dataset.i,1);
                localStorage.setItem('longTermFacts', JSON.stringify(longTermFacts));
                renderMemories();
            });
        }

        async function extractMemory(text) {
            try {
                const res = await fetch('/api/eastern-spirit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userMessage: text,
                        history: [],
                        relationship: { level: 1 },
                        memory: { userName: "轶群", longTermFacts: longTermFacts },
                        triggerType: "memory"
                    })
                });
                const data = await res.json();
                if (data.longTermFacts?.length) {
                    longTermFacts.push(...data.longTermFacts);
                    localStorage.setItem('longTermFacts', JSON.stringify(longTermFacts));
                }
            } catch (e) { console.error('记忆抽取失败:', e) }
        }

        async function sendMessageToAPI(text) {
            const loadingMsg = addBotMessage("……", true); // 占位消息
            try {
                const res = await fetch('/api/eastern-spirit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userMessage: text,
                        history: chatHistory.slice(-6),
                        relationship: { level: 1 },
                        memory: { userName: "轶群", longTermFacts: longTermFacts },
                        triggerType: "normal"
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || '服务请求失败');
                }

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() && line.startsWith('data: '));

                    for (const line of lines) {
                        if (line === 'data: [DONE]') break; // 结束标记
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.content) {
                                fullText += data.content;
                                // 更新占位消息的内容
                                loadingMsg.querySelector('p').textContent = fullText;
                            }
                        } catch (e) { continue; }
                    }
                }

                // 替换占位消息的记录
                chatHistory.pop();
                chatHistory.push({ role: 'assistant', content: fullText });
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

                await extractMemory(text); // 执行记忆抽取
            } catch (e) {
                console.error('发送失败:', e);
                chatHistory.pop();
                addBotMessage(`抱歉，出错了：${e.message}`);
            }
        }

        // 事件绑定
        sendBtn.onclick = () => {
            const t = userInput.value.trim();
            if (!t) return;
            addUserMessage(t);
            userInput.value = '';
            sendMessageToAPI(t);
        };

        userInput.onkeydown = e => e.key === 'Enter' && !e.shiftKey && sendBtn.click();
        memoryBtn.onclick = () => { renderMemories(); memoryModal.classList.remove('hidden'); };
        closeModal.onclick = () => memoryModal.classList.add('hidden');
        memoryModal.onclick = e => e.target === memoryModal && memoryModal.classList.add('hidden');

        clearMemories.onclick = () => {
            if (confirm('确定清空记忆？')) {
                longTermFacts = [];
                localStorage.setItem('longTermFacts', JSON.stringify(longTermFacts));
                renderMemories();
            }
        };

        exportMemories.onclick = () => {
            if (!longTermFacts.length) return alert('暂无记忆可导出');
            const blob = new Blob([JSON.stringify(longTermFacts, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `东方灵侍记忆_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        };

        // 初始化
        renderChat();
    </script>
</body>
</html>